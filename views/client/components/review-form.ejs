<%
// =================================================================
// REVIEW FORM COMPONENT
// =================================================================
// Props:
// - targetType: 'attraction', 'accommodation', 'food', 'entertainment', 'tour'
// - targetId: ID c·ªßa ƒë·ªëi t∆∞·ª£ng
// - user: User object
// =================================================================

const _targetType = targetType || 'attraction';
const _targetId = targetId || '';
const _user = user || null;
%>

<div class="review-form-wrapper" id="reviewFormWrapper">
  <div class="review-form-header">
    <h3 class="form-title" style="color: #fff;">G·ª≠i b√¨nh lu·∫≠n</h3>
    <!-- Rating stars trong header, cƒÉn gi·ªØa -->
    <div class="rating-input" id="ratingInput">
      <input type="hidden" name="rating" id="ratingValue" required>
      <div class="star-buttons">
        <button type="button" class="star-btn" data-rating="1">
          <span class="star-icon">‚òÖ</span>
        </button>
        <button type="button" class="star-btn" data-rating="2">
          <span class="star-icon">‚òÖ</span>
        </button>
        <button type="button" class="star-btn" data-rating="3">
          <span class="star-icon">‚òÖ</span>
        </button>
        <button type="button" class="star-btn" data-rating="4">
          <span class="star-icon">‚òÖ</span>
        </button>
        <button type="button" class="star-btn" data-rating="5">
          <span class="star-icon">‚òÖ</span>
        </button>
      </div>
      <div class="rating-label" id="ratingLabel"></div>
    </div>
  </div>

  <form id="reviewForm" class="review-form" enctype="multipart/form-data">
    <!-- =================================================================
         CONTENT v·ªõi EMOJI + UPLOAD b√™n trong
         ================================================================= -->
    <div class="form-group">
      <div class="content-input-wrapper">
        <textarea 
          id="reviewContent" 
          name="content" 
          class="form-control"
          rows="5"
          placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."
          required
        ></textarea>
        
        <!-- Toolbar v·ªõi emoji + upload -->
        <div class="content-toolbar">
          <!-- Emoji picker -->
          <div class="emoji-toolbar">
            <button type="button" class="emoji-picker-btn" id="emojiPickerBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line>
              </svg>
              <span>Emoji</span>
            </button>
          </div>
        </div>
        
        <!-- Upload button below emoji -->
        <div class="upload-section">
          <input 
            type="file" 
            id="reviewImages" 
            name="images" 
            accept="image/*"
            multiple
            class="file-input"
            style="display: none;"
          >
          <label for="reviewImages" class="upload-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span>Th√™m ·∫£nh</span>
          </label>
        </div>
        
        <!-- Image previews -->
        <div class="image-previews" id="imagePreviews"></div>
      </div>
    </div>

    <!-- Hidden title field -->
    <input type="hidden" id="reviewTitle" name="title" value="">

    <!-- =================================================================
         SUBMIT BUTTONS
         ================================================================= -->
    <div class="form-actions">
      <button type="submit" class="btn-submit" id="btnSubmit">
        <span class="btn-text">G·ª≠i b√¨nh lu·∫≠n</span>
        <span class="btn-loading" style="display: none;">
          ƒêang g·ª≠i...
        </span>
      </button>
    </div>
  </form>

  <!-- =================================================================
       SUCCESS MESSAGE
       ================================================================= -->
  <div class="success-message" id="successMessage" style="display: none;">
    <div class="success-icon">‚úì</div>
    <h3>C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!</h3>
    <p>ƒê√°nh gi√° c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát v√† hi·ªÉn th·ªã s·ªõm nh·∫•t.</p>
    <button type="button" class="btn-primary" onclick="location.reload()">
      Xem ƒë√°nh gi√°
    </button>
  </div>
</div>

<!-- =================================================================
     STYLES
     ================================================================= -->
<style>
/* ==========================
   FORM WRAPPER
   ========================== */
/* Override any external CSS that might interfere */
.review-form-wrapper * {
  box-sizing: border-box !important;
}

.review-form-wrapper {
  position: relative !important;
  z-index: 1 !important;
  isolation: isolate !important;
}

/* Prevent external CSS from affecting our components */
.review-form-wrapper .rating-input,
.review-form-wrapper .star-buttons,
.review-form-wrapper .star-btn,
.review-form-wrapper .star-icon {
  all: unset !important;
  display: revert !important;
  box-sizing: border-box !important;
}

/* Force all 5 stars to be visible */
.review-form-wrapper .star-buttons {
  display: flex !important;
  flex-wrap: nowrap !important;
  overflow: visible !important;
  width: 100% !important;
  max-width: 100% !important;
  position: relative !important;
  z-index: 10 !important;
}

.review-form-wrapper .star-btn {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  flex: 0 0 auto !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  z-index: 11 !important;
}

/* Ensure all 5 stars are always visible */
.review-form-wrapper .star-btn:nth-child(1),
.review-form-wrapper .star-btn:nth-child(2),
.review-form-wrapper .star-btn:nth-child(3),
.review-form-wrapper .star-btn:nth-child(4),
.review-form-wrapper .star-btn:nth-child(5) {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}
.review-form-wrapper {
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 8px !important;
  padding: 24px !important;
  margin: 0 auto 24px !important;
  width: 100% !important;
  max-width: 1000px !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
}

.review-form-wrapper .review-form-header {
  margin-bottom: 24px;
  text-align: center;
  padding-bottom: 16px;
  border-bottom: 1px solid #f3f4f6;
}

.review-form-wrapper .form-title {
  font-size: 1.125rem;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 16px 0;
  font-family: var(--ff-heading);
}

/* ==========================
   FORM GROUPS
   ========================== */
.review-form-wrapper .form-group {
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.review-form-wrapper .form-label {
  display: block;
  font-size: 0.8125rem;
  font-weight: 500;
  color: #374151;
  margin-bottom: 8px;
  font-family: var(--ff-primary);
}

/* Content Input Wrapper */
.review-form-wrapper .content-input-wrapper {
  border: 1px solid #d1d5db !important;
  border-radius: 8px !important;
  background: #ffffff !important;
  transition: all 0.2s !important;
  overflow: hidden !important;
  width: 100% !important;
  max-width: 900px !important;
  box-sizing: border-box !important;
  display: grid !important;
  grid-template-rows: auto auto auto !important;
  min-height: 200px !important;
}

.review-form-wrapper .content-input-wrapper:focus-within {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.review-form-wrapper .form-control {
  grid-column: 1 / 2 !important;
  grid-row: 1 / 3 !important;
  width: 100% !important;
  padding: 16px 18px !important;
  border: none !important;
  border-right: 1px solid #e5e7eb !important;
  border-radius: 0 !important;
  font-size: 0.875rem !important;
  font-family: var(--ff-primary) !important;
  background: transparent !important;
  resize: none !important;
  box-sizing: border-box !important;
  display: block !important;
  line-height: 1.5 !important;
  min-height: 200px !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
}

.review-form-wrapper .form-control:focus {
  outline: none;
}

/* ==========================
   RATING INPUT - In Header, Centered
   ========================== */
/* Force 5 stars to always be visible */
.review-form-wrapper .rating-input {
  position: relative !important;
  z-index: 10 !important;
  overflow: visible !important;
}

.review-form-wrapper .rating-input::before {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  /* background: #f8fafc !important; */
  border-radius: 8px !important;
  z-index: -1 !important;
}

/* Ensure all 5 stars are always visible */
.review-form-wrapper .star-buttons {
  display: flex !important;
  flex-wrap: nowrap !important;
  overflow: visible !important;
  position: relative !important;
  z-index: 5 !important;
  width: 100% !important;
  max-width: 100% !important;
}

.review-form-wrapper .star-btn {
  position: relative !important;
  z-index: 6 !important;
  flex: 0 0 auto !important;
  visibility: visible !important;
  opacity: 1 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 28px !important;
  max-width: 40px !important;
}
.review-form-wrapper .rating-input {
    text-align: center !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 12px auto 0 !important;
    max-width: 900px !important;
    padding: 16px 8px !important;
    /* background: #f8fafc !important; */
    border-radius: 8px !important;
    /* border: 1px solid #e2e8f0 !important; */
    width: 100% !important;
    box-sizing: border-box !important;
  }

.review-form-wrapper .star-buttons {
    display: flex !important;
    gap: 8px !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 8px !important;
    flex-wrap: nowrap !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 4px !important;
  }

.review-form-wrapper .star-btn {
    background: none !important;
    border: none !important;
    cursor: pointer !important;
    padding: 4px !important;
    transition: all 0.2s !important;
    line-height: 1 !important;
    border-radius: 4px !important;
    flex-shrink: 0 !important;
    min-width: 32px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

.review-form-wrapper .star-btn:hover {
  transform: scale(1.1);
  background: rgba(251, 191, 36, 0.1);
}

.review-form-wrapper .star-icon {
    font-size: 1.75rem !important;
    color: #d1d5db !important;
    transition: color 0.2s !important;
    display: block !important;
    line-height: 1 !important;
  }

/* Force star colors to display properly */
.review-form-wrapper .star-btn.active .star-icon,
.review-form-wrapper .star-btn:hover .star-icon {
  color: #fbbf24 !important;
}

.review-form-wrapper .star-btn:not(.active):not(:hover) .star-icon {
  color: #d1d5db !important;
}


.review-form-wrapper .rating-label {
  font-size: 0.875rem;
  color: var(--primary-color);
  font-weight: 500;
  min-height: 20px;
  margin-top: 4px;
  font-family: var(--ff-primary);
}

.review-form-wrapper .rating-label:empty {
  display: none;
}

/* ==========================
   CONTENT TOOLBAR - Emoji b√™n ph·∫£i
   ========================== */
.content-toolbar {
  grid-column: 2 / 3;
  grid-row: 1 / 2;
  padding: 16px 12px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.emoji-toolbar {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px;
  align-items: center;
  justify-items: center;
}

.emoji-picker-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: #ffffff;
  color: #6b7280;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.75rem;
  font-weight: 500;
  font-family: var(--ff-primary);
}

.emoji-picker-btn:hover {
  background: #f3f4f6;
  color: #374151;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

.emoji-picker-btn svg {
  flex-shrink: 0;
  width: 16px;
  height: 16px;
}

/* ==========================
   EMOJI PICKER MODAL
   ========================== */
.emoji-picker-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.emoji-picker-content {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 400px;
  max-height: 80vh;
  overflow: hidden;
  animation: emojiModalSlide 0.3s ease;
}

@keyframes emojiModalSlide {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.emoji-picker-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.emoji-picker-header h4 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #1a1a1a;
}

.emoji-picker-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.emoji-picker-close:hover {
  background: #e5e7eb;
  color: #374151;
}

.emoji-picker-body {
  padding: 16px 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.emoji-categories {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.emoji-category-btn {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 4px;
}

.emoji-category-btn:hover {
  background: #e5e7eb;
  border-color: #9ca3af;
}

.emoji-category-btn.active {
  background: var(--primary-color);
  color: #ffffff;
  border-color: var(--primary-color);
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  max-height: 300px;
  overflow-y: auto;
}

.emoji-item {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.25rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 40px;
}

.emoji-item:hover {
  background: #f3f4f6;
  transform: scale(1.1);
}

/* ==========================
   UPLOAD SECTION - B√™n ph·∫£i d∆∞·ªõi emoji
   ========================== */
.upload-section {
  grid-column: 2 / 3;
  grid-row: 2 / 3;
  padding: 12px;
  background: #f9fafb;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-btn {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px 16px;
  background: #ffffff;
  color: #6b7280;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 500;
  transition: all 0.2s;
  white-space: nowrap;
  font-family: var(--ff-primary);
}

.upload-btn:hover {
  background: #f3f4f6;
  color: #374151;
  border-color: #9ca3af;
  transform: translateY(-2px);
}

.upload-btn svg {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
}

/* ==========================
   IMAGE PREVIEWS
   ========================== */
.image-previews {
  grid-column: 1 / 3;
  grid-row: 3 / 4;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  padding: 16px 18px 12px;
  background: #ffffff;
  border-top: 1px solid #e5e7eb;
}

.image-previews:empty {
  display: none;
}

.image-preview-item {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #e5e7eb;
  transition: all 0.2s;
}

.image-preview-item:hover {
  border-color: var(--primary-color);
  transform: scale(1.02);
}

.preview-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-image {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 24px;
  height: 24px;
  background: rgba(239, 68, 68, 0.95);
  color: #ffffff;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  line-height: 1;
  padding: 0;
  font-weight: bold;
}

.remove-image:hover {
  background: #dc2626;
  transform: scale(1.1);
}

/* ==========================
   FORM ACTIONS
   ========================== */
.form-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin: 24px auto 0;
  max-width: 900px;
  padding-top: 20px;
  border-top: 1px solid #e5e7eb;
}

.btn-submit {
  padding: 14px 36px;
  background: var(--primary-color);
  color: #ffffff;
  border: none;
  border-radius: 25px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  overflow: hidden;
  font-family: var(--ff-primary);
  min-width: 160px;
}

.btn-submit::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-submit:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  background: #2563eb;
}

.btn-submit:hover:not(:disabled)::before {
  left: 100%;
}

.btn-submit:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.spinner-small {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ==========================
   SUCCESS MESSAGE
   ========================== */
.success-message {
  text-align: center;
  padding: 48px 24px;
}

.success-icon {
  width: 80px;
  height: 80px;
  background: #10b981;
  color: #ffffff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  margin: 0 auto 20px;
  animation: successPop 0.5s ease;
}

@keyframes successPop {
  0% { transform: scale(0); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.success-message h3 {
  font-size: 1.5rem;
  color: #111827;
  margin-bottom: 8px;
}

.success-message p {
  font-size: 0.9375rem;
  color: #6b7280;
  margin-bottom: 24px;
}

/* ==========================
   DESKTOP SPECIFIC
   ========================== */
@media (min-width: 769px) {
  .review-form-wrapper .content-input-wrapper {
    grid-template-columns: 1fr 180px !important;
    margin: 0 auto 16px !important;
  }
}

/* ==========================
   RESPONSIVE
   ========================== */
@media (max-width: 768px) {
  .review-form-wrapper {
    padding: 20px 16px !important;
    margin: 0 auto 20px !important;
    max-width: 100% !important;
  }

  .form-title {
    font-size: 1.125rem;
  }

  .rating-input {
    padding: 14px 10px;
    margin: 8px auto 0;
    max-width: 100%;
    width: 100%;
  }

  .star-buttons {
    gap: 6px !important;
    width: 100% !important;
    justify-content: space-between !important;
    padding: 0 8px !important;
    flex-wrap: nowrap !important;
    overflow: visible !important;
    position: relative !important;
    z-index: 10 !important;
  }

  .star-btn {
    padding: 4px !important;
    flex: 0 0 auto !important;
    min-width: 24px !important;
    max-width: 32px !important;
    position: relative !important;
    z-index: 11 !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .star-icon {
    font-size: 1.5rem !important;
  }
  
  /* Mobile: ƒê∆∞a emoji v√† upload xu·ªëng d∆∞·ªõi */
  .content-input-wrapper {
    display: grid !important;
    max-width: 100% !important;
    min-height: 150px !important;
    grid-template-columns: 1fr !important;
    grid-template-rows: auto auto auto auto !important;
    margin: 0 !important;
  }
  
  .form-control {
    width: 100% !important;
    border: none !important;
    border-bottom: 1px solid #e5e7eb !important;
    min-height: 120px !important;
    font-size: 0.875rem !important;
    padding: 12px 16px !important;
    line-height: 1.5 !important;
    overflow-wrap: break-word !important;
    word-break: break-word !important;
    grid-column: 1 / 2 !important;
    grid-row: 1 / 2 !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  .content-toolbar {
    padding: 12px 16px !important;
    border-bottom: 1px solid #e5e7eb !important;
    grid-column: 1 / 2 !important;
    grid-row: 2 / 3 !important;
  }
  
  .emoji-toolbar {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .emoji-btn {
    font-size: 1.125rem;
    width: 36px;
    height: 36px;
    padding: 6px;
  }

  .emoji-picker-content {
    width: 85%;
    max-width: 420px;
  }

  .emoji-grid {
    grid-template-columns: repeat(8, 1fr);
  }
  
  .upload-section {
    padding: 12px 16px !important;
    grid-column: 1 / 2 !important;
    grid-row: 3 / 4 !important;
  }
  
  .upload-btn {
    flex-direction: row;
    padding: 10px 20px;
    font-size: 0.8125rem;
  }
  
  .upload-btn svg {
    width: 18px;
    height: 18px;
  }

  .form-actions {
    justify-content: center;
    margin: 20px auto 0;
    max-width: 100%;
    padding-top: 16px;
  }

  .btn-submit {
    width: 100%;
    max-width: 100%;
    padding: 12px 24px;
  }

  .image-preview-item {
    width: 80px;
    height: 80px;
  }

  .image-previews {
    gap: 8px !important;
    padding: 12px 16px 8px !important;
    grid-column: 1 / 2 !important;
    grid-row: 4 / 5 !important;
  }
}

@media (max-width: 480px) {
  .review-form-wrapper {
    padding: 16px 12px !important;
    margin: 0 auto 16px !important;
    max-width: 100% !important;
  }

  .form-title {
    font-size: 1rem;
  }

  .rating-input {
    padding: 12px 8px;
    width: 100%;
  }

  .star-buttons {
    gap: 4px !important;
    width: 100% !important;
    justify-content: space-between !important;
    padding: 0 4px !important;
    flex-wrap: nowrap !important;
    overflow: visible !important;
  }

  .star-btn {
    padding: 2px !important;
    flex: 0 0 auto !important;
    min-width: 20px !important;
    max-width: 28px !important;
  }

  .star-icon {
    font-size: 1.25rem !important;
  }

  .emoji-btn {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }

  .emoji-picker-content {
    width: 95%;
    max-width: 350px;
  }

  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
  }

  .emoji-categories {
    gap: 4px;
  }

  .emoji-category-btn {
    padding: 6px 8px;
    font-size: 0.875rem;
  }

  .form-control {
    padding: 12px 14px !important;
    min-height: 100px !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    overflow-wrap: break-word !important;
    word-break: break-word !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  .image-preview-item {
    width: 70px;
    height: 70px;
  }

  .emoji-picker-content {
    width: 95%;
    max-width: 350px;
  }

  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
  }

  .emoji-categories {
    gap: 4px;
  }

  .emoji-category-btn {
    padding: 6px 8px;
    font-size: 0.875rem;
  }
}

@media (max-width: 375px) {
  .rating-input {
    padding: 10px 6px;
    width: 100%;
  }

  .star-buttons {
    gap: 3px !important;
    width: 100% !important;
    justify-content: space-between !important;
    padding: 0 2px !important;
    flex-wrap: nowrap !important;
    overflow: visible !important;
  }

  .star-btn {
    padding: 1px !important;
    flex: 0 0 auto !important;
    min-width: 18px !important;
    max-width: 24px !important;
  }

  .star-icon {
    font-size: 1.125rem !important;
  }
}

@media (max-width: 350px) {
  .rating-input {
    padding: 10px 4px;
  }

  .star-buttons {
    gap: 2px !important;
    justify-content: space-between !important;
    padding: 0 1px !important;
    flex-wrap: nowrap !important;
    overflow: visible !important;
  }

  .star-btn {
    padding: 0 !important;
    min-width: 16px !important;
    max-width: 20px !important;
  }

  .star-icon {
    font-size: 1rem !important;
  }
}

@media (max-width: 320px) {
  .review-form-wrapper {
    padding: 12px 8px !important;
    margin: 0 auto 12px !important;
  }

  .star-buttons {
    gap: 1px !important;
    padding: 0 1px !important;
    justify-content: space-between !important;
    flex-wrap: nowrap !important;
    overflow: visible !important;
  }

  .star-btn {
    padding: 0 !important;
    min-width: 14px !important;
    max-width: 18px !important;
  }

  .star-icon {
    font-size: 0.875rem !important;
  }

  .form-control {
    padding: 10px 12px !important;
    font-size: 0.8125rem !important;
    line-height: 1.5 !important;
    overflow-wrap: break-word !important;
    word-break: break-word !important;
    min-height: 80px !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  .emoji-picker-content {
    width: 98%;
    max-width: 320px;
  }

  .emoji-grid {
    grid-template-columns: repeat(5, 1fr);
  }

  .emoji-categories {
    gap: 2px;
  }

  .emoji-category-btn {
    padding: 4px 6px;
    font-size: 0.75rem;
  }

  .emoji-picker-content {
    width: 98%;
    max-width: 300px;
  }

  .emoji-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .emoji-categories {
    gap: 1px;
  }

  .emoji-picker-content {
    width: 98%;
    max-width: 300px;
  }

  .emoji-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}
</style>

<!-- =================================================================
     SCRIPT
     ================================================================= -->
<script>
(function() {
  const form = document.getElementById('reviewForm');
  const ratingInput = document.getElementById('ratingInput');
  const ratingValue = document.getElementById('ratingValue');
  const ratingLabel = document.getElementById('ratingLabel');
  const titleInput = document.getElementById('reviewTitle');
  const contentInput = document.getElementById('reviewContent');
  const imagesInput = document.getElementById('reviewImages');
  const imagePreviews = document.getElementById('imagePreviews');
  const btnSubmit = document.getElementById('btnSubmit');
  const successMessage = document.getElementById('successMessage');
  
  const targetType = '<%= _targetType %>';
  const targetId = '<%= _targetId %>';
  
  let selectedRating = 0;
  let selectedImages = [];

  // =================================================================
  // RATING STARS
  // =================================================================
  const starButtons = ratingInput.querySelectorAll('.star-btn');
  starButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      selectedRating = parseInt(this.dataset.rating);
      ratingValue.value = selectedRating;
      
      // Update UI
      starButtons.forEach((b, idx) => {
        if (idx < selectedRating) {
          b.classList.add('active');
          b.querySelector('.star-icon').style.color = '#fbbf24';
        } else {
          b.classList.remove('active');
          b.querySelector('.star-icon').style.color = '#d1d5db';
        }
      });
    });

    btn.addEventListener('mouseenter', function() {
      const rating = parseInt(this.dataset.rating);
      starButtons.forEach((b, idx) => {
        if (idx < rating) {
          b.querySelector('.star-icon').style.color = '#fbbf24';
        } else {
          b.querySelector('.star-icon').style.color = '#d1d5db';
        }
      });
    });

    btn.addEventListener('mouseleave', function() {
      starButtons.forEach((b, idx) => {
        if (idx < selectedRating) {
          b.classList.add('active');
          b.querySelector('.star-icon').style.color = '#fbbf24';
        } else {
          b.classList.remove('active');
          b.querySelector('.star-icon').style.color = '#d1d5db';
        }
      });
    });
  });

  // =================================================================
  // EMOJI PICKER
  // =================================================================
  const emojiPickerBtn = document.getElementById('emojiPickerBtn');
  
  emojiPickerBtn.addEventListener('click', function() {
    // T·∫°o emoji picker modal
    const emojiPicker = document.createElement('div');
    emojiPicker.className = 'emoji-picker-modal';
    emojiPicker.innerHTML = `
      <div class="emoji-picker-content">
        <div class="emoji-picker-header">
          <h4>Ch·ªçn emoji</h4>
          <button type="button" class="emoji-picker-close">&times;</button>
        </div>
        <div class="emoji-picker-body">
          <div class="emoji-categories">
            <button type="button" class="emoji-category-btn active" data-category="smileys">üòä</button>
            <button type="button" class="emoji-category-btn" data-category="people">üë•</button>
            <button type="button" class="emoji-category-btn" data-category="animals">üê∂</button>
            <button type="button" class="emoji-category-btn" data-category="food">üçï</button>
            <button type="button" class="emoji-category-btn" data-category="travel">‚úàÔ∏è</button>
            <button type="button" class="emoji-category-btn" data-category="activities">‚öΩ</button>
            <button type="button" class="emoji-category-btn" data-category="objects">üì±</button>
            <button type="button" class="emoji-category-btn" data-category="symbols">‚ù§Ô∏è</button>
            <button type="button" class="emoji-category-btn" data-category="flags">üè≥Ô∏è</button>
          </div>
          <div class="emoji-grid" id="emojiGrid">
            <!-- Emojis will be loaded here -->
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(emojiPicker);
    
    // Load emojis
    loadEmojis('smileys');
    
    // Category switching
    emojiPicker.querySelectorAll('.emoji-category-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Remove active class from all buttons
        emojiPicker.querySelectorAll('.emoji-category-btn').forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        // Load emojis for selected category
        loadEmojis(this.dataset.category);
      });
    });
    
    // Close modal
    emojiPicker.querySelector('.emoji-picker-close').addEventListener('click', () => {
      document.body.removeChild(emojiPicker);
    });
    
    // Close on outside click
    emojiPicker.addEventListener('click', (e) => {
      if (e.target === emojiPicker) {
        document.body.removeChild(emojiPicker);
      }
    });
  });
  
  function loadEmojis(category) {
    const emojiGrid = document.getElementById('emojiGrid');
    const emojis = getEmojisByCategory(category);
    
    emojiGrid.innerHTML = emojis.map(emoji => 
      `<button type="button" class="emoji-item" data-emoji="${emoji}">${emoji}</button>`
    ).join('');
    
    // Add click handlers
    emojiGrid.querySelectorAll('.emoji-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const emoji = this.dataset.emoji;
        const cursorPos = contentInput.selectionStart;
        const textBefore = contentInput.value.substring(0, cursorPos);
        const textAfter = contentInput.value.substring(cursorPos);
        contentInput.value = textBefore + emoji + textAfter;
        contentInput.focus();
        contentInput.selectionStart = contentInput.selectionEnd = cursorPos + emoji.length;
        
        // Close modal
        const modal = document.querySelector('.emoji-picker-modal');
        if (modal) {
          document.body.removeChild(modal);
        }
      });
    });
  }
  
  function getEmojisByCategory(category) {
    const emojiData = {
      smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê'],
      people: ['üë∂', 'üßí', 'üë¶', 'üëß', 'üßë', 'üë®', 'üë©', 'üßì', 'üë¥', 'üëµ', 'üë±', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'üë®‚Äçü¶≥', 'üë©‚Äçü¶≥', 'üë®‚Äçü¶≤', 'üë©‚Äçü¶≤', 'üßî', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'üë®‚Äçüé§', 'üë©‚Äçüé§', 'üë®‚Äçüè´', 'üë©‚Äçüè´', 'üë®‚Äçüè≠', 'üë©‚Äçüè≠', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüî¨', 'üë©‚Äçüî¨', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüé®', 'üë©‚Äçüé®', 'üë®‚Äçüöí', 'üë©‚Äçüöí', 'üë®‚Äç‚úàÔ∏è', 'üë©‚Äç‚úàÔ∏è', 'üë®‚ÄçüöÄ', 'üë©‚ÄçüöÄ', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öñÔ∏è', 'üë®‚Äçüåæ', 'üë©‚Äçüåæ', 'üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üë®‚Äçüîß', 'üë©‚Äçüîß', 'üë®‚Äçüè≠', 'üë©‚Äçüè≠', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüî¨', 'üë©‚Äçüî¨', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüé®', 'üë©‚Äçüé®', 'üë®‚Äçüöí', 'üë©‚Äçüöí', 'üë®‚Äç‚úàÔ∏è', 'üë©‚Äç‚úàÔ∏è', 'üë®‚ÄçüöÄ', 'üë©‚ÄçüöÄ', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öñÔ∏è', 'üë®‚Äçüåæ', 'üë©‚Äçüåæ', 'üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üë®‚Äçüîß', 'üë©‚Äçüîß'],
      animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'ü¶ç', 'ü¶ß', 'üêï', 'üê©', 'üê∫', 'ü¶ä', 'ü¶ù', 'üê±', 'ü¶Å', 'üêØ', 'üêÖ', 'üêÜ', 'üê¥', 'ü¶Ñ', 'ü¶ì', 'ü¶å', 'üêÆ', 'üêÇ', 'üêÉ', 'üêÑ', 'üê∑', 'üêñ', 'üêó', 'üêΩ', 'üêè', 'üêë', 'üêê', 'üê™', 'üê´', 'ü¶ô', 'ü¶í', 'üêò', 'ü¶è', 'ü¶õ', 'üê≠', 'üêÅ', 'üêÄ', 'üêπ', 'üê∞', 'üêá', 'üêøÔ∏è', 'ü¶î', 'ü¶á', 'üêª', 'üê®', 'üêº', 'ü¶•', 'ü¶¶', 'ü¶®', 'ü¶°', 'ü¶É', 'üêî', 'üêì', 'üê£', 'üê§', 'üê•', 'üê¶', 'üêß', 'üïäÔ∏è', 'ü¶Ö', 'ü¶Ü', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î'],
      food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•ñ', 'üçû', 'ü•®', 'ü•Ø', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü´ì', 'ü•ô', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 'ü•ò', 'ü´ï', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ'],
      travel: ['‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', 'üöß', '‚õΩ', 'üöè', 'üö¶', 'üö•', 'üó∫Ô∏è', 'üóø', 'üóΩ', 'üóº', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèîÔ∏è', '‚õ∞Ô∏è', 'üåã', 'üóª', 'üèïÔ∏è', '‚õ∫', 'üõñ', 'üè†', 'üè°', 'üèòÔ∏è', 'üèöÔ∏è', 'üèóÔ∏è', 'üè≠', 'üè¢', 'üè¨', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè™', 'üè´', 'üè©', 'üíí', 'üèõÔ∏è', '‚õ™', 'üïå', 'üõï', 'üïç', 'üïã', '‚õ©Ô∏è', 'üõ§Ô∏è', 'üõ£Ô∏è', 'üóæ', 'üéë', 'üèûÔ∏è', 'üåÖ', 'üåÑ', 'üå†', 'üéá', 'üéÜ', 'üåá', 'üåÜ', 'üèôÔ∏è', 'üåÉ', 'üåå', 'üåâ', 'üåÅ'],
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üèãÔ∏è', 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§º‚Äç‚ôÇÔ∏è', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§∏', 'ü§∏‚Äç‚ôÇÔ∏è', '‚õπÔ∏è‚Äç‚ôÄÔ∏è', '‚õπÔ∏è', '‚õπÔ∏è‚Äç‚ôÇÔ∏è', 'ü§∫', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§æ', 'ü§æ‚Äç‚ôÇÔ∏è', 'üèåÔ∏è‚Äç‚ôÄÔ∏è', 'üèåÔ∏è', 'üèåÔ∏è‚Äç‚ôÇÔ∏è', 'üèá', 'üßò‚Äç‚ôÄÔ∏è', 'üßò', 'üßò‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèÑ‚Äç‚ôÇÔ∏è', 'üèä‚Äç‚ôÄÔ∏è', 'üèä', 'üèä‚Äç‚ôÇÔ∏è', 'ü§Ω‚Äç‚ôÄÔ∏è', 'ü§Ω', 'ü§Ω‚Äç‚ôÇÔ∏è', 'üö£‚Äç‚ôÄÔ∏è', 'üö£', 'üö£‚Äç‚ôÇÔ∏è', 'üßó‚Äç‚ôÄÔ∏è', 'üßó', 'üßó‚Äç‚ôÇÔ∏è', 'üöµ‚Äç‚ôÄÔ∏è', 'üöµ', 'üöµ‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÄÔ∏è', 'üö¥', 'üö¥‚Äç‚ôÇÔ∏è', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π', 'ü§π‚Äç‚ôÄÔ∏è', 'ü§π‚Äç‚ôÇÔ∏è', 'üé≠', 'ü©∞', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéµ', 'üé∂', 'ü™ò', 'ü•Å', 'ü™ó', 'üé∏', 'ü™ï', 'üé∫', 'üé∑', 'ü™ó', 'üéπ', 'üéª', 'ü™ï', 'üé∏', 'üé∫', 'üé∑', 'ü™ó', 'üéπ', 'üéª'],
      objects: ['üì±', 'üì≤', '‚òéÔ∏è', 'üìû', 'üìü', 'üì†', 'üîã', 'üîå', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üé•', 'üì∑', 'üì∏', 'üìπ', 'üìº', 'üîç', 'üîé', 'üïØÔ∏è', 'üí°', 'üî¶', 'üèÆ', 'ü™î', 'üìî', 'üìï', 'üìñ', 'üìó', 'üìò', 'üìô', 'üìö', 'üìì', 'üìí', 'üìÉ', 'üìú', 'üìÑ', 'üì∞', 'üóûÔ∏è', 'üìë', 'üîñ', 'üè∑Ô∏è', 'üí∞', 'üí¥', 'üíµ', 'üí∂', 'üí∑', 'üí∏', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', 'ü™¶', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ', 'üß¥', 'üß∑', 'üß∏', 'üßµ', 'üß∂', 'ü™°', 'ü™¢', 'üß¶', 'üß§', 'üß•', 'ü¶∫', 'üëï', 'üëñ', 'ü©±', 'ü©≤', 'ü©≥', 'üëî', 'üëó', 'üëô', 'üëö', 'üëõ', 'üëú', 'üëù', 'üõçÔ∏è', 'üéí', 'üëû', 'üëü', 'ü•æ', 'ü•ø', 'üë†', 'üë°', 'ü©∞', 'üë¢', 'üëë', 'üëí', 'üé©', 'üéì', 'üß¢', '‚õëÔ∏è', 'üìø', 'üíÑ', 'üíç', 'üíé'],
      symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', '‚öß', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', 'üî§', '‚ÑπÔ∏è', 'üî¢', 'üî°', 'üÜï', 'üÜì', 'üÜí', 'üÜë', 'üÜî', 'üÜó', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂', 'üàØ', 'üâê', '„äóÔ∏è', '„äôÔ∏è', 'üà∫', 'üàµ', 'üà¥', 'üà≤', 'üâë', 'üà∏', 'üàπ', 'üàö', 'üì∂', 'üàÅ', 'üî£', 'üî§', '‚ÑπÔ∏è', 'üî¢', 'üî°', 'üÜï', 'üÜì', 'üÜí', 'üÜë', 'üÜî', 'üÜó', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂', 'üàØ', 'üâê', '„äóÔ∏è', '„äôÔ∏è', 'üà∫', 'üàµ', 'üà¥', 'üà≤', 'üâë', 'üà∏', 'üàπ', 'üàö'],
      flags: ['üè≥Ô∏è', 'üè¥', 'üèÅ', 'üö©', 'üè≥Ô∏è‚Äçüåà', 'üè≥Ô∏è‚Äç‚ößÔ∏è', 'üè¥‚Äç‚ò†Ô∏è', 'üá¶üá®', 'üá¶üá©', 'üá¶üá™', 'üá¶üá´', 'üá¶üá¨', 'üá¶üáÆ', 'üá¶üá±', 'üá¶üá≤', 'üá¶üá¥', 'üá¶üá∂', 'üá¶üá∑', 'üá¶üá∏', 'üá¶üáπ', 'üá¶üá∫', 'üá¶üáº', 'üá¶üáΩ', 'üá¶üáø', 'üáßüá¶', 'üáßüáß', 'üáßüá©', 'üáßüá™', 'üáßüá´', 'üáßüá¨', 'üáßüá≠', 'üáßüáÆ', 'üáßüáØ', 'üáßüá±', 'üáßüá≤', 'üáßüá≥', 'üáßüá¥', 'üáßüá∂', 'üáßüá∑', 'üáßüá∏', 'üáßüáπ', 'üáßüáª', 'üáßüáº', 'üáßüáæ', 'üáßüáø', 'üá®üá¶', 'üá®üá®', 'üá®üá©', 'üá®üá´', 'üá®üá¨', 'üá®üá≠', 'üá®üáÆ', 'üá®üá∞', 'üá®üá±', 'üá®üá≤', 'üá®üá≥', 'üá®üá¥', 'üá®üáµ', 'üá®üá∑', 'üá®üá∫', 'üá®üáª', 'üá®üáº', 'üá®üáΩ', 'üá®üáæ', 'üá®üáø', 'üá©üá™', 'üá©üá¨', 'üá©üáØ', 'üá©üá∞', 'üá©üá≤', 'üá©üá¥', 'üá©üáø', 'üá™üá¶', 'üá™üá®', 'üá™üá™', 'üá™üá¨', 'üá™üá≠', 'üá™üá∑', 'üá™üá∏', 'üá™üáπ', 'üá™üá∫', 'üá´üáÆ', 'üá´üáØ', 'üá´üá∞', 'üá´üá≤', 'üá´üá¥', 'üá´üá∑', 'üá¨üá¶', 'üá¨üáß', 'üá¨üá©', 'üá¨üá™', 'üá¨üá´', 'üá¨üá¨', 'üá¨üá≠', 'üá¨üáÆ', 'üá¨üá±', 'üá¨üá≤', 'üá¨üá≥', 'üá¨üáµ', 'üá¨üá∂', 'üá¨üá∑', 'üá¨üá∏', 'üá¨üáπ', 'üá¨üá∫', 'üá¨üáº', 'üá¨üáæ', 'üá≠üá∞', 'üá≠üá≤', 'üá≠üá≥', 'üá≠üá∑', 'üá≠üáπ', 'üá≠üá∫', 'üáÆüá®', 'üáÆüá©', 'üáÆüá™', 'üáÆüá±', 'üáÆüá≤', 'üáÆüá≥', 'üáÆüá¥', 'üáÆüá∂', 'üáÆüá∑', 'üáÆüá∏', 'üáÆüáπ', 'üáØüá™', 'üáØüá≤', 'üáØüá¥', 'üáØüáµ', 'üá∞üá™', 'üá∞üá¨', 'üá∞üá≠', 'üá∞üáÆ', 'üá∞üá≤', 'üá∞üá≥', 'üá∞üáµ', 'üá∞üá∑', 'üá∞üáº', 'üá∞üáæ', 'üá∞üáø', 'üá±üá¶', 'üá±üáß', 'üá±üá®', 'üá±üáÆ', 'üá±üá∞', 'üá±üá∑', 'üá±üá∏', 'üá±üáπ', 'üá±üá∫', 'üá±üáª', 'üá±üáæ', 'üá≤üá¶', 'üá≤üá®', 'üá≤üá©', 'üá≤üá™', 'üá≤üá´', 'üá≤üá¨', 'üá≤üá≠', 'üá≤üá∞', 'üá≤üá±', 'üá≤üá≤', 'üá≤üá≥', 'üá≤üá¥', 'üá≤üáµ', 'üá≤üá∂', 'üá≤üá∑', 'üá≤üá∏', 'üá≤üáπ', 'üá≤üá∫', 'üá≤üáª', 'üá≤üáº', 'üá≤üáΩ', 'üá≤üáæ', 'üá≤üáø', 'üá≥üá¶', 'üá≥üá®', 'üá≥üá™', 'üá≥üá´', 'üá≥üá¨', 'üá≥üáÆ', 'üá≥üá±', 'üá≥üá¥', 'üá≥üáµ', 'üá≥üá∑', 'üá≥üá∫', 'üá≥üáø', 'üá¥üá≤', 'üáµüá¶', 'üáµüá™', 'üáµüá´', 'üáµüá¨', 'üáµüá≠', 'üáµüá∞', 'üáµüá±', 'üáµüá≤', 'üáµüá≥', 'üáµüá∑', 'üáµüá∏', 'üáµüáπ', 'üáµüáº', 'üáµüáæ', 'üá∂üá¶', 'üá∑üá™', 'üá∑üá¥', 'üá∑üá∏', 'üá∑üá∫', 'üá∑üáº', 'üá∏üá¶', 'üá∏üáß', 'üá∏üá®', 'üá∏üá©', 'üá∏üá™', 'üá∏üá¨', 'üá∏üá≠', 'üá∏üáÆ', 'üá∏üáØ', 'üá∏üá∞', 'üá∏üá±', 'üá∏üá≤', 'üá∏üá≥', 'üá∏üá¥', 'üá∏üá∑', 'üá∏üá∏', 'üá∏üáπ', 'üá∏üáª', 'üá∏üáΩ', 'üá∏üáæ', 'üá∏üáø', 'üáπüá¶', 'üáπüá®', 'üáπüá©', 'üáπüá´', 'üáπüá¨', 'üáπüá≠', 'üáπüáØ', 'üáπüá∞', 'üáπüá±', 'üáπüá≤', 'üáπüá≥', 'üáπüá¥', 'üáπüá∑', 'üáπüáπ', 'üáπüáª', 'üáπüáº', 'üáπüáø', 'üá∫üá¶', 'üá∫üá¨', 'üá∫üá≤', 'üá∫üá≥', 'üá∫üá∏', 'üá∫üáæ', 'üá∫üáø', 'üáªüá¶', 'üáªüá®', 'üáªüá™', 'üáªüá¨', 'üáªüáÆ', 'üáªüá≥', 'üáªüá∫', 'üáºüá´', 'üáºüá∏', 'üáΩüá∞', 'üáæüá™', 'üáæüáπ', 'üáøüá¶', 'üáøüá≤', 'üáøüáº']
    };
    
    return emojiData[category] || emojiData.smileys;
  }

  // =================================================================
  // IMAGE UPLOAD
  // =================================================================
  imagesInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    
    // Limit to 5 images
    if (selectedImages.length + files.length > 5) {
      alert('B·∫°n ch·ªâ c√≥ th·ªÉ t·∫£i l√™n t·ªëi ƒëa 5 ·∫£nh');
      return;
    }

    files.forEach(file => {
      if (file.type.startsWith('image/')) {
        selectedImages.push(file);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview" class="preview-image">
            <button type="button" class="remove-image" onclick="removeImage(${selectedImages.length - 1})">√ó</button>
          `;
          imagePreviews.appendChild(div);
        };
        reader.readAsDataURL(file);
      }
    });

    // Clear input
    imagesInput.value = '';
  });

  window.removeImage = function(index) {
    selectedImages.splice(index, 1);
    renderImagePreviews();
  };

  function renderImagePreviews() {
    imagePreviews.innerHTML = '';
    selectedImages.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" alt="Preview" class="preview-image">
          <button type="button" class="remove-image" onclick="removeImage(${index})">√ó</button>
        `;
        imagePreviews.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }

  // No cancel button in simple form

  // =================================================================
  // FORM SUBMIT
  // =================================================================
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validation
    if (!selectedRating) {
      alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°');
      return;
    }

    if (!contentInput.value.trim()) {
      alert('Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°');
      return;
    }

    // Show loading
    btnSubmit.disabled = true;
    btnSubmit.querySelector('.btn-text').style.display = 'none';
    btnSubmit.querySelector('.btn-loading').style.display = 'inline-flex';

    try {
      const formData = new FormData();
      formData.append('rating', selectedRating);
      formData.append('title', titleInput.value);
      formData.append('content', contentInput.value);
      
      // Add images
      selectedImages.forEach(file => {
        formData.append('images', file);
      });

      // Debug logging
      console.log('=== FORM DATA DEBUG ===');
      console.log('Rating:', selectedRating);
      console.log('Title:', titleInput.value);
      console.log('Content:', contentInput.value);
      console.log('Images:', selectedImages.length);
      for (let pair of formData.entries()) {
        console.log(pair[0], ':', pair[1]);
      }

      const response = await fetch(`/api/reviews/${targetType}/${targetId}`, {
        method: 'POST',
        body: formData
      });

      // Check if response is JSON
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        // Not JSON, probably redirected to login
        throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°');
      }

      const data = await response.json();

      if (response.status === 401) {
        // Unauthorized - need login
        throw new Error(data.message || 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°');
      }

      if (data.success) {
        // Show success message
        form.style.display = 'none';
        successMessage.style.display = 'block';
      } else {
        throw new Error(data.message || 'C√≥ l·ªói x·∫£y ra');
      }
    } catch (error) {
      console.error('Submit error:', error);
      
      // If it's a login error, offer to redirect
      if (error.message.includes('ƒëƒÉng nh·∫≠p')) {
        const shouldRedirect = confirm(error.message + '\n\nB·∫°n c√≥ mu·ªën ƒë·∫øn trang ƒëƒÉng nh·∫≠p kh√¥ng?');
        if (shouldRedirect) {
          window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
      } else {
        alert(error.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i.');
      }
      
      // Reset loading state
      btnSubmit.disabled = false;
      btnSubmit.querySelector('.btn-text').style.display = 'inline';
      btnSubmit.querySelector('.btn-loading').style.display = 'none';
    }
  });
})();
</script>

